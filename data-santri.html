<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Santri</title>
  <link rel="stylesheet" href="style.css">
  <style>
  #tabelWrapper {
    overflow-x: auto;
    max-width: 100%;
    border: 1px solid #ccc;
    margin-top: 12px;
  }

  table {
    border-collapse: collapse;
    font-size: 13px;
    width: 800px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: left;
    white-space: nowrap;
  }
</style>
</head>
<body>
  <nav class="topbar">
  <div class="topbar-left">
    <img src="img/igg.png" alt="Logo WOSAE">
    <div class="topbar-title">WOSAE - Dashboard</div>
  </div>
  <div class="topbar-toggle" onclick="toggleNav()">â˜°</div>
  <div class="topbar-links" id="topbarLinks">
    <a href="dashboard.html" class="nav-item">Beranda</a>
    <div class="dropdown">
      <a href="#">Divisi â–¼</a>
      <div class="dropdown-content">
        <a href="divisi.html">Semua Divisi</a>
        <a href="divisi-dekorasi.html">Dekorasi</a>
        <a href="divisi-acara.html">Acara</a>
        <a href="divisi-perkap.html">Perkap</a>
        <a href="divisi-konsumsi.html">Konsumsi</a>
      </div>
    </div>
    <a href="data-santri.html" class="nav-item">Data Santri</a>
    <a href="brosur.html" class="nav-item">Brosur</a>
    <a href="log.html" class="nav-item">Log</a>
    <a href="index.html" class="logout" onclick="logout()">Logout</a>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">ðŸŒ“ Mode</button>
  </div>
</nav>
<header>
    <h2>Data Santri WOSAE</h2>
  </header>
  <main>
    <form id="formSantri">
      <input type="text" id="nama" placeholder="Nama Santri" required>
      <input type="text" id="asal" placeholder="Asal Sekolah" required>
      <input type="text" id="alamat" placeholder="Alamat" required>
      <input type="text" id="hp" placeholder="Nomor HP" required>
      <select id="status">
        <option value="Belum Lunas">Belum Lunas</option>
        <option value="Lunas">Lunas</option>
      </select>
      <button type="submit">Tambah Santri</button>
    </form>

    <input type="text" id="searchInput" placeholder="Cari nama santri...">
    <button id="exportBtn">Ekspor ke Excel</button>
    <div id="tabelWrapper">
    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>Asal Sekolah</th>
          <th>Alamat</th>
          <th>No HP</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelSantri">
        <!-- Data santri ditambahkan di sini -->
      </tbody>
    </table>
    </div>
  </main>

  <script>
    function toggleNav() {
    document.getElementById('topbarLinks').classList.toggle('show');
  }

  const links = document.querySelectorAll(".nav-item");
  links.forEach(link => {
    if (link.href === window.location.href) {
      link.classList.add("active");
    }
  });

  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') document.body.classList.add('dark');

  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    const newTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
  }
  function logout() {
    localStorage.removeItem("savedUsername");
    localStorage.removeItem("remember");
    window.location.href = "login.html"; // Redirect ke halaman login
  }

  </script>
  <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const supabaseUrl = 'https://gmbwlgvobwclmqrqxqvd.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtYndsZ3ZvYndjbG1xcnF4cXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjEwMzcsImV4cCI6MjA2OTk5NzAzN30.iXzfMXcIcyokTKbzrTpxvdfoQ7UCzoYqJ2HzxN_x6Ck';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const form = document.getElementById("formSantri");
  const tabelSantri = document.getElementById("tabelSantri");
  const searchInput = document.getElementById("searchInput");
  const exportBtn = document.getElementById("exportBtn");

  let santriList = [];

  async function fetchSantri(filter = "") {
    const { data, error } = await supabase.from("santri").select("*");
    if (error) {
      console.error("Gagal ambil data:", error);
      return;
    }
    santriList = data;
    renderTable(filter);
  }

  function renderTable(filter = "") {
    tabelSantri.innerHTML = "";
    if (!santriList.length) {
      tabelSantri.innerHTML = `<tr><td colspan="5" style="text-align:center;">Belum ada data santri.</td></tr>`;
      return;
    }

    const filtered = santriList.filter(s => s.nama?.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach((s) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="font-size: 13px; padding: 6px 8px;">${s.nama || ""}</td>
        <td style="font-size: 13px; padding: 6px 8px;">${s.asal || ""}</td>
        <td style="font-size: 13px; padding: 6px 8px;">${s.alamat || ""}</td>
        <td style="font-size: 13px; padding: 6px 8px;">${s.hp || ""}</td>
        <td style="font-size: 13px; padding: 6px 8px;">${s.status || ""}</td>
      `;
      tabelSantri.appendChild(row);
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const santri = {
      nama: document.getElementById("nama").value,
      asal: document.getElementById("asal").value,
      alamat: document.getElementById("alamat").value,
      hp: document.getElementById("hp").value,
      status: document.getElementById("status").value
    };

    const { error } = await supabase.from("santri").insert([santri]);
    if (error) {
      console.error("Gagal tambah santri:", error);
    } else {
      form.reset();
      await fetchSantri();
    }
  });

  searchInput.addEventListener("input", () => {
    renderTable(searchInput.value);
  });

  exportBtn.addEventListener("click", async () => {
    const { utils, writeFileXLSX } = await import('https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs');
    if (!santriList.length) {
      alert("Data masih kosong atau belum dimuat.");
      return;
    }

    const headers = ["Nama", "Asal Sekolah", "Alamat", "No HP", "Status"];
    const data = santriList.map(s => [
      s.nama || "",
      s.asal || "",
      s.alamat || "",
      s.hp || "",
      s.status || ""
    ]);

    const all = [headers, ...data];
    const worksheet = utils.aoa_to_sheet(all);
    const workbook = utils.book_new();
    utils.book_append_sheet(workbook, worksheet, "Data Santri");

    writeFileXLSX(workbook, "data-santri.xlsx");
  });

  fetchSantri();

  // ðŸ‘‡ expose function globally untuk onclick="hapusSantri(id)"
  window.hapusSantri = async function(id) {
    await supabaseClient.from("santri").delete().eq("id", id);
    fetchSantri();
  };
  </script>
</body>
</html>